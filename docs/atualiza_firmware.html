<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>ICW — Controle do LED + OTA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; max-width:720px; }
    .row { display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap: wrap; }
    .ok { color:#0a0 } .bad { color:#a00 }
    code { background:#f6f6f6; padding:2px 6px; border-radius:6px }
    input[type=text] { width: 100%; max-width: 520px; padding:8px; }
    button { padding:8px 12px; }
    .muted { color:#666; font-size: 12px; }
  </style>
</head>
<body>
  <h2>ICW — Controle do LED (Web) + OTA</h2>

  <div class="card">
    <div class="row">
      <label>Estado da conexão:</label>
      <span id="conn" class="bad">desconectado</span>
    </div>
    <div class="row">
      <button id="btnConnect">Conectar</button>
      <button id="btnDisconnect">Desconectar</button>
    </div>

    <hr/>

    <h3>LED</h3>
    <div class="row">
      <label>LED atual (reportado):</label>
      <strong id="ledState">?</strong>
    </div>
    <div class="row">
      <button id="btnOn">Ligar LED</button>
      <button id="btnOff">Desligar LED</button>
    </div>

    <hr/>

    <h3>OTA (atualização de firmware)</h3>
    <div class="row">
      <input id="otaUrl" type="text"
             placeholder="https://.../firmware.bin" />
      <button id="btnOTA">Atualizar firmware</button>
    </div>
    <div id="otaHint" class="muted"></div>

    <p class="muted">Tópicos:
      <br/>cmd: <code id="tCmd"></code>
      <br/>reported: <code id="tRep"></code>
      <br/>ack (opc.): <code id="tAck"></code>
      <br/>lwt (opc.): <code id="tLwt"></code>
    </p>
  </div>

<script>
  // ======= CONFIG — ajuste para o seu ambiente =======
  const ORG_ID    = "app-user-org01";
  const DEVICE_ID = "device-dev01";

  const BROKER_WSS = "wss://x82148af.ala.us-east-1.emqxsl.com:8084/mqtt";
  const APP_USER   = "app-web";
  const APP_PASS   = "1234";

  // Se você colocou firmware.bin em /docs do GitHub Pages, use essa URL:
  const OTA_URL_DEFAULT = "https://raw.githubusercontent.com/perferroengenharia-ux/ICW_IHM/main/docs/firmware.bin";

  const TOPIC_CMD = `org/${ORG_ID}/devices/${DEVICE_ID}/cmd`;
  const TOPIC_REP = `org/${ORG_ID}/devices/${DEVICE_ID}/state/reported`;
  const TOPIC_ACK = `org/${ORG_ID}/devices/${DEVICE_ID}/ack/#`; // opcional
  const TOPIC_LWT = `org/${ORG_ID}/devices/${DEVICE_ID}/lwt`;   // opcional

  // Mostrar tópicos na UI
  document.getElementById('tCmd').textContent = TOPIC_CMD;
  document.getElementById('tRep').textContent = TOPIC_REP;
  document.getElementById('tAck').textContent = TOPIC_ACK;
  document.getElementById('tLwt').textContent = TOPIC_LWT;

  // Preencher URL de OTA
  const $otaUrl = document.getElementById('otaUrl');
  $otaUrl.value = OTA_URL_DEFAULT;
  document.getElementById('otaHint').textContent =
    'Dica: hospede o arquivo .bin em HTTPS (ex.: GitHub Pages) para que o navegador permita a conexão.';

  let client = null;
  const $conn = document.getElementById('conn');
  const $led  = document.getElementById('ledState');

  function setConn(ok){
    $conn.textContent = ok ? 'conectado' : 'desconectado';
    $conn.className   = ok ? 'ok' : 'bad';
  }

  function connect(){
    if (client && client.connected) return;
    const cid = 'web-' + Math.random().toString(16).slice(2);
    client = mqtt.connect(BROKER_WSS, {
      clientId: cid, username: APP_USER, password: APP_PASS,
      keepalive: 60, clean: true,
      reconnectPeriod: 2000, connectTimeout: 8000, protocolVersion: 4
    });

    client.on('connect', () => {
      setConn(true);
      client.subscribe([TOPIC_REP, TOPIC_ACK, TOPIC_LWT], { qos: 1 }, (err) => {
        if (err) console.error('SUB erro:', err);
      });
    });

    client.on('reconnect', () => setConn(false));
    client.on('close', () => setConn(false));
    client.on('error', (e) => console.error('MQTT error', e));

    client.on('message', (topic, payload) => {
      if (topic === TOPIC_REP) {
        try {
          const json = JSON.parse(payload.toString());
          const ledOn = json?.hw?.led_on;
          if (typeof ledOn === 'boolean') $led.textContent = ledOn ? 'ON' : 'OFF';
        } catch(e){ console.warn('JSON inválido', e); }
      } else if (topic.startsWith(`org/${ORG_ID}/devices/${DEVICE_ID}/ack/`)) {
        console.log('ACK:', payload.toString());
      } else if (topic === TOPIC_LWT) {
        console.log('LWT:', payload.toString()); // 'online' / 'offline'
      }
    });
  }

  function disconnect(){
    if (client) { const c = client; client = null; c.end(true); }
    setConn(false);
  }

  function publishCmd(obj){
    if (!client || !client.connected) { alert('Conecte primeiro'); return; }
    client.publish(TOPIC_CMD, JSON.stringify(obj), { qos: 1, retain: false });
  }

  function led(on){
    publishCmd({ msgId: 'led-' + Date.now(), op: 'led', data: { on } });
  }

  function doOTA(){
    const url = $otaUrl.value.trim();
    if (!url || !/^https:\/\//i.test(url)) {
      alert('Informe uma URL HTTPS válida para o firmware (.bin).');
      return;
    }
    if (!confirm(`Iniciar OTA com:\n${url}\n\nO dispositivo irá reiniciar ao concluir.`)) return;

    publishCmd({ msgId: 'ota-' + Date.now(), op: 'ota', data: { url } });
    alert('Comando de OTA enviado! Acompanhe o log serial do ESP32.');
  }

  document.getElementById('btnConnect').onclick = connect;
  document.getElementById('btnDisconnect').onclick = disconnect;
  document.getElementById('btnOn').onclick  = () => led(true);
  document.getElementById('btnOff').onclick = () => led(false);
  document.getElementById('btnOTA').onclick = doOTA;
</script>
</body>
</html>
